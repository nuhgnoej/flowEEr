# 🌸 FlowEEr – 온디바이스 앱 프로젝트 (MVP)

## 🏗️ 프로젝트 개요

**FlowEEr는 파워 유저를 위한 루틴 알림 앱입니다.**

- 플로우(Flow)를 설계하고, 스텝(Step)을 연결하고, 조건(Trigger)에 따라 자동으로 알림을 받습니다.
- 서버 없이 **온디바이스(Local DB)** 환경에서 작동합니다.
- 반복되는 일상과 업무를 체계적으로 관리할 수 있습니다.

---

## 🚀 핵심 개념 및 작동 원리

| 요소        | 설명                                                          |
| ----------- | ------------------------------------------------------------- |
| **Flow**    | 하나의 작업 흐름, 루틴 단위 (예: 아침 준비, 운동 루틴 등)     |
| **Step**    | 플로우 내 단일 작업 또는 알림 단위 (예: 기상, 양치, 출근)     |
| **Trigger** | 특정 시간 또는 다른 Step과의 관계로 Step을 실행하는 조건 설정 |

- 기준 스텝의 **완료** 시점을 기준으로 상대 시간 계산 가능
- 트리거는 **"시간 기반"** 또는 **"스텝 상태 기반"**으로 작동

---

## ⏰ Trigger Type 정의 (최신)

| 트리거        | 설명                                              | 주요 필드                        |
| ------------- | ------------------------------------------------- | -------------------------------- |
| **`at_time`** | 특정 절대 시간에 실행                             | `time` (예: "07:00")             |
| **`delay`**   | 특정 스텝(들)의 **완료 후 N초 뒤 실행**           | `targetStepIds`(배열), `offset`  |
| **`after`**   | **하나 또는 여러 개의 스텝 완료 후 실행**         | `targetStepIds` (배열)           |
| **`end`**     | 플로우 내 **모든 스텝 완료 후 실행**              | 없음                             |

> ✔️ 트리거 배열 중 **하나라도 조건을 만족하면 해당 스텝이 실행됩니다.**
> ✔️ delay/after의 타겟 스텝은 여러 개 선택 가능하며, delay는 오프셋(±)도 지원합니다.

---

## 🗂️ 데이터베이스 스키마 (최신)

| 테이블      | 컬럼              | 타입      | 제약 조건                                          | 설명                                             |
| ----------- | ----------------- | --------- | -------------------------------------------------- | ------------------------------------------------ |
| **flow**    | `id`              | INTEGER   | PRIMARY KEY                                        | 플로우 ID                                        |
|             | `name`            | TEXT      | NOT NULL                                           | 플로우 이름                                      |
|             | `description`     | TEXT      |                                                    | 플로우 설명 (선택)                               |
| **step**    | `id`              | INTEGER   | PRIMARY KEY                                        | 스텝 ID                                          |
|             | `flow_id`         | INTEGER   | NOT NULL, FOREIGN KEY → flow(id) ON DELETE CASCADE | 소속 플로우 ID                                   |
|             | `name`            | TEXT      | NOT NULL                                           | 스텝 이름                                        |
|             | `description`     | TEXT      |                                                    | 스텝 설명 (선택)                                 |
| **trigger** | `id`              | TEXT      | PRIMARY KEY                                        | 트리거 ID (UUID/숫자)                            |
|             | `step_id`         | INTEGER   | NOT NULL, FOREIGN KEY → step(id) ON DELETE CASCADE | 연결된 스텝 ID                                   |
|             | `type`            | TEXT      | NOT NULL                                           | 트리거 타입 (`at_time`, `delay`, `after`, `end`) |
|             | `target_step_ids` | TEXT      | JSON 배열 형태                                     | 타겟 스텝 목록                                   |
|             | `offset`          | INTEGER   |                                                    | 오프셋(±초 단위, delay용)                        |
|             | `time`            | TEXT      |                                                    | at_time용 절대 시간 ("HH:mm")                    |

---

## ⚙️ Flow Engine & Scheduler

- `FlowEngine`는 각 스텝의 상태와 예상 실행 시간을 계산해 UI에 필요한 정보를 제공합니다.
- `FlowScheduler`는 준비된 스텝을 기반으로 Expo Notifications 알림을 예약하며,
  스텝 완료 시 다음 알림을 자동으로 설정할 예정입니다.

---
## 🎯 동작 시나리오 예시

### 📄 순차적 실행

- **기상 (07:00) → 양치 (완료 후 2분 뒤) → 세수 (완료 후 즉시)**

| 스텝 | 트리거                      |
| ---- | --------------------------- |
| 기상 | at_time (07:00)             |
| 양치 | delay (기상 완료 후 +120초) |
| 세수 | delay (양치 완료 후 +0초)   |

---

### 📄 병렬 실행 + 동기화

- **아침 준비와 이메일 확인을 동시에 시작, 두 작업 모두 완료 후 출발 알림**

| 스텝        | 트리거                                   |
| ----------- | ---------------------------------------- |
| 아침 준비   | at_time (07:00)                          |
| 이메일 확인 | delay (아침 준비 완료 후 +0초)           |
| 출발 알림   | after (아침 준비 완료, 이메일 확인 완료) |

---

### 📄 플로우 완료 후 실행

- 모든 준비가 완료된 후 **"이제 출발하세요"** 알림

| 스텝      | 트리거 |
| --------- | ------ |
| 출발 안내 | end    |

---

## 🔥 기술 스택

| 영역         | 사용 기술                                   |
| ------------ | ------------------------------------------- |
| 프레임워크   | React Native + Expo                         |
| 상태 관리    | React Context (Zustand 예정)                |
| 데이터베이스 | SQLite (expo-sqlite, Async 기반)            |
| UI 컴포넌트  | React Native + Custom Modal + Wheely Picker |
| 알람         | Expo Notifications (개발 중)                |

---

## ✅ 현재 진행 상황

| 기능                    | 상태                              |
| ----------------------- | --------------------------------- |
| 플로우 생성/수정/삭제   | ✅ 완료                           |
| 스텝 추가/편집/삭제     | ✅ 완료                           |
| 트리거 설정 (시간/상대) | ✅ 리팩토링 완료 (새 모델 적용)   |
| 로컬 저장 (SQLite)      | ✅ 완료                           |
| 로컬 알람 실행          | 🔥 개발 중 (expo-notifications)   |
| 플로우 실행 화면        | ✅ 기본 실행 기능 구현            |
| 클라우드 연동           | ❌ 미지원 (MVP는 온디바이스 전용) |
| 사용자 계정             | ❌ 미지원                         |

---

## 🚀 다음 단계

- [ ] 로컬 알림 완전 연결 및 테스트
- [ ] 스케줄러 로직 개선 및 테스트
- [x] 시간 계산 엔진 설계 및 구현
- [x] 플로우 실행 화면 UI 및 상태 관리 설계
- [ ] 트리거 에디터 UX 최종 개선 (오프셋 ± 지원 등)
- [ ] 스텝 상태 관리 개선 (시작/완료 UI 처리)
- [ ] 알림 → 확인 다이얼로그 → 완료 처리 흐름 완성
- [ ] 앱 안정화 및 MVP 마감

---

## 💡 슬로건

> **"시간을 설계하고, 흐름을 만들고, 삶을 피워낸다." – FlowEEr**

---

## 📜 실행 방법

```bash
npx expo start
```

- DB 초기화는 앱 구동 시 자동 수행됨
- 또는 수동 실행

```ts
import { initDatabase } from "@/lib/db";
initDatabase();
```

---

> © 2025 flowEEr. All rights reserved.
